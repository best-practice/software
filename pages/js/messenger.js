window.Messenger=(function(){var d="[PROJECT_NAME]",a="postMessage" in window;function c(g,e){var f="";if(arguments.length<2){f="target error - target and name are both requied"}else{if(typeof g!="object"){f="target error - target itself must be window object"}else{if(typeof e!="string"){f="target error - target name must be string type"}}}if(f){throw new Error(f)}this.target=g;this.name=e}if(a){c.prototype.send=function(e){this.target.postMessage(d+e,"*")}}else{c.prototype.send=function(f){var e=window.navigator[d+this.name];if(typeof e=="function"){e(d+f,window)}else{throw new Error("target callback function is not defined")}}}function b(e){this.targets={};this.name=e;this.listenFunc=[];this.initListen()}b.prototype.addTarget=function(g,e){var f=new c(g,e);this.targets[e]=f};b.prototype.initListen=function(){var f=this;var e=function(h){if(typeof h=="object"&&h.data){h=h.data}h=h.slice(d.length);for(var g=0;g<f.listenFunc.length;g++){f.listenFunc[g](h)}};if(a){if("addEventListener" in document){window.addEventListener("message",e,false)}else{if("attachEvent" in document){window.attachEvent("onmessage",e)}}}else{window.navigator[d+this.name]=e}};b.prototype.listen=function(e){this.listenFunc.push(e)};b.prototype.clear=function(){this.listenFunc=[]};b.prototype.send=function(g){var e=this.targets,f;for(f in e){if(e.hasOwnProperty(f)){e[f].send(g)}}};return b})();window.Messenger.DCF=(function(){var d=false;var c={id:1};var b=function(e,f){var g=document.querySelector('iframe[id="'+f+'"]');if(g){e.addTarget(g.contentWindow,f);return e.targets[f]}else{return null}};var a=function(){var f="",h=false;if(window.parent===window||!window.parent){f="parent"}else{if(!document.body){console.log("!! abnormal DCF state: document.body not ready yet")}else{h=true;f=document.body.getAttribute("name")||""}if(!f){f="parent"}}var g=new Messenger(f);this.messenger=g;this.name=f;if(f!="parent"){this.messenger.addTarget(window.parent.window,"parent")}var e=this;g.listen(function(k){var n=null,l=f;try{n=JSON.parse(k)}catch(p){console.log(p);return}if(n.method=="<setName>"){var m=(h?g.targets.parent:null);if(m){var o=n.param[0];var j={sour:o,method:"<reply>",id:n.id,timeout:0,param:[n.id,n.method,{isReady:true,state:"OK",oldName:e.name}]};if(o!=e.name){e.name=o;e.messenger.name=o;if(!window.postMessage){window.navigator["[PROJECT_NAME]"+o]=window.navigator["[PROJECT_NAME]"+j.oldName]}}if(n.timeout>0){m.send(JSON.stringify(j))}}return}var i=a["DCF-"+n.method];if(typeof i=="function"){if(n.timeout<=0){i(n.param)}else{var j;try{j={sour:l,method:"<reply>",id:n.id,timeout:0,param:[n.id,n.method,i(n.param)]}}catch(p){j={sour:l,method:"<error>",id:n.id,timeout:0,param:[n.id,n.method,p.name+": "+p.message]}}var m=g.targets[n.sour];if(!m&&n.sour!="parent"){m=g.targets.parent}if(m){m.send(JSON.stringify(j))}}}else{if(n.timeout>0){var j={sour:l,method:"<unsupport>",id:n.id,timeout:0,param:[n.id,n.method,l]};var m=g.targets[n.sour];if(!m&&n.sour!="parent"){m=g.targets.parent}if(m){m.send(JSON.stringify(j))}}}});d=true};a.ver="DCF-1.0";a.prototype.call=function(e,j,h,n,m,l){if(!e||!j){return}if(e==this.name){console.log("messenger target is loop-back: "+e);return}h=(h instanceof Array)?h:[];n=(n===undefined)?0:n;var f,k=false;if((typeof m=="function")&&n>0){k=true}else{n=0}if(k){var i=c.id;c.id=i+1;c[i]=m;setTimeout(function(){if(c[i]){delete c[i];if(j=="<isReady>"||j=="<setName>"){m({isReady:false})}else{if(l){l({isTimeout:true})}else{console.log("Call DCF method ("+e+"."+j+") timeout")}}}},n);f={sour:this.name,method:j,id:i,timeout:n,param:h}}else{f={sour:this.name,method:j,id:0,timeout:0,param:h}}var g=this.messenger.targets[e];if(!g&&e!="parent"){g=b(this.messenger,e);if(!g){console.log("messenger target (iframe.id="+e+") not found")}}if(g){g.send(JSON.stringify(f))}};a.prototype.regist=function(e,f){if(typeof e!="string"||e.length==0){throw Error("Invalid argument pass to DCF.regist()")}if(typeof f=="function"){a["DCF-"+e]=f}else{delete a["DCF-"+e]}};a.prototype.isReady=function(f,e,g){var h=this.messenger.targets[f];if(!h&&f!="parent"){h=b(this.messenger,f);if(!h){console.log("messenger target (iframe.id="+f+") not found")}}if(h){this.call(f,"<isReady>",[],e,g)}else{if(g){g({isReady:false})}}};a.prototype.setPeerName=function(f,i,e,g){if(f=="parent"){return}var h=this.messenger.targets[f];if(!h){h=b(this.messenger,f);if(!h){console.log("messenger target (iframe.id="+f+") not found")}}if(h){if(i){this.call(f,"<setName>",[i],e,g)}}else{if(g){g({isReady:false})}}};a["DCF-<isReady>"]=function(e){return{isReady:d,ver:a.ver}};a["DCF-<reply>"]=function(f){var e=f[0];if(e>0){var g=c[e];delete c[e];if(typeof g=="function"){g(f[2])}}};a["DCF-<unsupport>"]=function(f){var e=f[0];if(e>0){delete c[e]}var g="Method ("+f[1]+") not defined at "+f[2];alert(g)};a["DCF-<error>"]=function(f){var e=f[0];if(e>=0){delete c[e]}console.log("Call DCF method ("+f[1]+") meet error, "+f[2])};return a})();
