window.Messenger=(function(){var d="[PROJECT_NAME]",a="postMessage" in window;function c(g,e){var f="";if(arguments.length<2){f="target error - target and name are both requied"}else{if(typeof g!="object"){f="target error - target itself must be window object"}else{if(typeof e!="string"){f="target error - target name must be string type"}}}if(f){throw new Error(f)}this.target=g;this.name=e}if(a){c.prototype.send=function(e){this.target.postMessage(d+e,"*")}}else{c.prototype.send=function(f){var e=window.navigator[d+this.name];if(typeof e=="function"){e(d+f,window)}else{throw new Error("target callback function is not defined")}}}function b(e){this.targets={};this.name=e;this.listenFunc=[];this.initListen()}b.prototype.addTarget=function(g,e){var f=new c(g,e);this.targets[e]=f};b.prototype.initListen=function(){var f=this;var e=function(h){if(typeof h=="object"&&h.data){h=h.data}h=h.slice(d.length);for(var g=0;g<f.listenFunc.length;g++){f.listenFunc[g](h)}};if(a){if("addEventListener" in document){window.addEventListener("message",e,false)}else{if("attachEvent" in document){window.attachEvent("onmessage",e)}}}else{window.navigator[d+this.name]=e}};b.prototype.listen=function(e){this.listenFunc.push(e)};b.prototype.clear=function(){this.listenFunc=[]};b.prototype.send=function(g){var e=this.targets,f;for(f in e){if(e.hasOwnProperty(f)){e[f].send(g)}}};return b})();window.Messenger.DCF=(function(){var d=false;var c={id:1};var b=function(e,f){var g=document.querySelector('iframe[id="'+f+'"]');if(g){e.addTarget(g.contentWindow,f);return e.targets[f]}else{return null}};var a=function(){var f="",h=false;if(window.parent===window||!window.parent){f="parent"}else{if(!document.body){console.log("!! abnormal DCF state: document.body not ready yet")}else{h=true;f=document.body.getAttribute("name")||""}if(!f){f="parent"}}var g=new Messenger(f);this.messenger=g;this.name=f;if(f!="parent"){this.messenger.addTarget(window.parent.window,"parent")}var e=this;g.listen(function(p){var i=null,o=e.name;try{i=JSON.parse(p)}catch(l){console.log(l);return}if(a.verbose){console.log("DCF("+o+").receive> "+p)}if(i.method=="<setName>"){var k=(h?g.targets.parent:null);if(k){var j=i.param[0];var m={sour:j,method:"<reply>",id:i.id,timeout:0,param:[i.id,i.method,{isReady:true,state:"OK",oldName:e.name}]};if(j!=e.name){e.name=j;e.messenger.name=j;if(!window.postMessage){window.navigator["[PROJECT_NAME]"+j]=window.navigator["[PROJECT_NAME]"+m.oldName]}}if(i.timeout>0){var q=JSON.stringify(m);if(a.verbose){console.log("DCF.reply(parent)> "+q)}k.send(q)}}return}var n=a["DCF-"+i.method];if(typeof n=="function"){if(i.timeout<=0){n(i.param)}else{var m;try{m={sour:o,method:"<reply>",id:i.id,timeout:0,param:[i.id,i.method,n(i.param)]}}catch(l){m={sour:o,method:"<error>",id:i.id,timeout:0,param:[i.id,i.method,l.name+": "+l.message]}}var k=g.targets[i.sour];if(!k&&i.sour!="parent"){k=g.targets.parent}if(k){var q=JSON.stringify(m);if(a.verbose){console.log("DCF.reply("+i.sour+")> "+q)}k.send(q)}}}else{if(i.timeout>0){var m={sour:o,method:"<unsupport>",id:i.id,timeout:0,param:[i.id,i.method,o]};var k=g.targets[i.sour];if(!k&&i.sour!="parent"){k=g.targets.parent}if(k){var q=JSON.stringify(m);if(a.verbose){console.log("DCF.reply("+i.sour+")> "+q)}k.send(q)}}}});d=true};a.ver="DCF-1.0";a.verbose=false;a.prototype.call=function(e,j,h,n,m,l){if(!e||!j){return}if(e==this.name){console.log("messenger target is loop-back: "+e);return}h=(h instanceof Array)?h:[];n=(n===undefined)?0:n;var f,k=false;if((typeof m=="function")&&n>0){k=true}else{n=0}if(k){var i=c.id;c.id=i+1;c[i]=m;setTimeout(function(){if(c[i]){delete c[i];if(j=="<isReady>"||j=="<setName>"){m({isReady:false})}else{if(l){l({isTimeout:true})}else{console.log("Call DCF method ("+e+"."+j+") timeout")}}}},n);f={sour:this.name,method:j,id:i,timeout:n,param:h}}else{f={sour:this.name,method:j,id:0,timeout:0,param:h}}var g=this.messenger.targets[e];if(!g&&e!="parent"){g=b(this.messenger,e);if(!g){console.log("messenger target (iframe.id="+e+") not found")}}if(g){var o=JSON.stringify(f);if(a.verbose){console.log("DCF("+f.sour+").send> "+o)}g.send(o)}};a.prototype.regist=function(e,f){if(typeof e!="string"||e.length==0){throw Error("Invalid argument pass to DCF.regist()")}if(typeof f=="function"){a["DCF-"+e]=f}else{delete a["DCF-"+e]}};a.prototype.isReady=function(f,e,g){var h=this.messenger.targets[f];if(!h&&f!="parent"){h=b(this.messenger,f);if(!h){console.log("messenger target (iframe.id="+f+") not found")}}if(h){this.call(f,"<isReady>",[],e,g)}else{if(g){g({isReady:false})}}};a.prototype.listTarget=function(){var e=[];for(var f in this.messenger.targets){e.push(f)}return e};a.prototype.removeTarget=function(e){var f=this.messenger.targets[e];if(f){delete this.messenger.targets[e];return true}else{return false}};a.prototype.setPeerName=function(f,i,e,g){if(f=="parent"){return}var h=this.messenger.targets[f];if(!h){h=b(this.messenger,f);if(!h){console.log("messenger target (iframe.id="+f+") not found")}}if(h){if(i){this.call(f,"<setName>",[i],e,g)}}else{if(g){g({isReady:false})}}};a["DCF-<isReady>"]=function(e){return{isReady:d,ver:a.ver}};a["DCF-<reply>"]=function(f){var e=f[0];if(e>0){var g=c[e];delete c[e];if(typeof g=="function"){g(f[2])}}};a["DCF-<unsupport>"]=function(f){var e=f[0];if(e>0){delete c[e]}var g="Method ("+f[1]+") not defined at "+f[2];alert(g)};a["DCF-<error>"]=function(f){var e=f[0];if(e>=0){delete c[e]}console.log("Call DCF method ("+f[1]+") meet error, "+f[2])};return a})();